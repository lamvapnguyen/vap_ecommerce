(function(){function i(n,t,i){for(var r,u=n.createTreeWalker(t,NodeFilter.SHOW_ALL,null,!1);r=u.nextNode();)if(i&&!i(r)||r.nodeType==3&&r.nodeValue&&/[^\s\u00a0]+/.test(r.nodeValue)||r.nodeType==1&&/^(HR|IMG|TABLE)$/.test(r.nodeName))return!1;return!0}var n=tinymce.dom.Event,r=tinymce.grep,t=tinymce.each,u=tinymce.inArray;tinymce.create("tinymce.plugins.Safari",{init:function(u){var e=this,f;tinymce.isWebKit&&(e.editor=u,e.webKitFontSizes=["x-small","small","medium","large","x-large","xx-large","-webkit-xxx-large"],e.namedFontSizes=["xx-small","x-small","small","medium","large","x-large","xx-large"],u.addCommand("CreateLink",function(n,t){var i=u.selection.getNode(),r=u.dom,f;i&&(/^(left|right)$/i.test(r.getStyle(i,"float",1))||/^(left|right)$/i.test(r.getAttrib(i,"align")))?(f=r.create("a",{href:t},i.cloneNode()),i.parentNode.replaceChild(f,i),u.selection.select(f)):u.getDoc().execCommand("CreateLink",!1,t)}),u.onKeyUp.add(function(n,t){var u,i,r,f,e;(t.keyCode==46||t.keyCode==8)&&(i=n.getBody(),u=i.innerHTML,e=n.selection,i.childNodes.length!=1||/<(img|hr)/.test(u)||tinymce.trim(u.replace(/<[^>]+>/g,"")).length!=0||(n.setContent('<p><br mce_bogus="1" /><\/p>',{format:"raw"}),f=i.firstChild,r=e.getRng(),r.setStart(f,0),r.setEnd(f,0),e.setRng(r)))}),u.addCommand("FormatBlock",function(n,t){var i=u.dom,r=i.getParent(u.selection.getNode(),i.isBlock);r?i.replace(i.create(t),r,1):u.getDoc().execCommand("FormatBlock",!1,t)}),u.addCommand("mceInsertContent",function(n,t){u.getDoc().execCommand("InsertText",!1,"mce_marker");u.getBody().innerHTML=u.getBody().innerHTML.replace(/mce_marker/g,u.dom.processHTML(t)+'<span id="_mce_tmp">XX<\/span>');u.selection.select(u.dom.get("_mce_tmp"));u.getDoc().execCommand("Delete",!1," ")}),u.onKeyPress.add(function(t,r){var v,h,c,o,l,u,y,s,p,w,a;if(r.keyCode==13&&(y=t.selection,v=y.getNode(),(r.shiftKey||t.settings.force_br_newlines&&v.nodeName!="LI")&&(e._insertBR(t),n.cancel(r)),(h=f.getParent(v,"LI"))&&(c=f.getParent(h,"OL,UL"),s=t.getDoc(),a=f.create("p"),f.add(a,"br",{mce_bogus:"1"}),i(s,h))))return(u=f.getParent(c.parentNode,"LI,OL,UL"))?void 0:(u=f.getParent(c,"p,h1,h2,h3,h4,h5,h6,div")||c,o=s.createRange(),o.setStartBefore(u),o.setEndBefore(h),l=s.createRange(),l.setStartAfter(h),l.setEndAfter(u),p=o.cloneContents(),w=l.cloneContents(),i(s,w)||f.insertAfter(w,u),f.insertAfter(a,u),i(s,p)||f.insertAfter(p,u),f.remove(u),u=a.firstChild,o=s.createRange(),o.setStartBefore(u),o.setEndBefore(u),y.setRng(o),n.cancel(r))}),u.onExecCommand.add(function(n,t){var i,r,u,f;(t=="InsertUnorderedList"||t=="InsertOrderedList")&&(i=n.selection,r=n.dom,(u=r.getParent(i.getNode(),function(n){return/^(H[1-6]|P|ADDRESS|PRE)$/.test(n.nodeName)}))&&(f=i.getBookmark(),r.remove(u,1),i.moveToBookmark(f)))}),u.onClick.add(function(n,t){t=t.target;t.nodeName=="IMG"?(e.selElm=t,n.selection.select(t)):e.selElm=null}),u.onInit.add(function(){e._fixWebKitSpans()}),u.onSetContent.add(function(){f=u.dom;t(["strong","b","em","u","strike","sub","sup","a"],function(n){t(r(f.select(n)).reverse(),function(n){var i=n.nodeName.toLowerCase(),t;if(i=="a"){n.name&&f.replace(f.create("img",{mce_name:"a",name:n.name,"class":"mceItemAnchor"}),n);return}switch(i){case"b":case"strong":i=="b"&&(i="strong");t="font-weight: bold;";break;case"em":t="font-style: italic;";break;case"u":t="text-decoration: underline;";break;case"sub":t="vertical-align: sub;";break;case"sup":t="vertical-align: super;";break;case"strike":t="text-decoration: line-through;"}f.replace(f.create("span",{mce_name:i,style:t,"class":"Apple-style-span"}),n,1)})})}),u.onPreProcess.add(function(n,i){f=n.dom;t(r(i.node.getElementsByTagName("span")).reverse(),function(t){var r;if(i.get&&f.hasClass(t,"Apple-style-span")){r=t.style.backgroundColor;switch(f.getAttrib(t,"mce_name")){case"font":n.settings.convert_fonts_to_spans||f.setAttrib(t,"style","");break;case"strong":case"em":case"sub":case"sup":f.setAttrib(t,"style","");break;case"strike":case"u":n.settings.inline_styles?f.setAttrib(t,"mce_name",""):f.setAttrib(t,"style","");break;default:n.settings.inline_styles||f.setAttrib(t,"style","")}r&&(t.style.backgroundColor=r)}f.hasClass(t,"mceItemRemoved")&&f.remove(t,1)})}),u.onPostProcess.add(function(n,t){t.content=t.content.replace(/<br \/><\/(h[1-6]|div|p|address|pre)>/g,"<\/$1>");t.content=t.content.replace(/ id=\"undefined\"/g,"")}))},getInfo:function(){return{longname:"Safari compatibility",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/safari",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_fixWebKitSpans:function(){var t=this,i=t.editor;n.add(i.getDoc(),"DOMNodeInserted",function(n){n=n.target;n&&n.nodeType==1&&t._fixAppleSpan(n)})},_fixAppleSpan:function(n){var r=this.editor,t=r.dom,f=this.webKitFontSizes,e=this.namedFontSizes,o=r.settings,i;t.getAttrib(n,"mce_fixed")||n.nodeName=="SPAN"&&n.className=="Apple-style-span"&&(i=n.style,o.convert_fonts_to_spans?i.fontSize&&t.setStyle(n,"fontSize",e[u(f,i.fontSize)]):(i.fontSize&&(t.setAttrib(n,"mce_name","font"),t.setAttrib(n,"size",u(f,i.fontSize)+1)),i.fontFamily&&(t.setAttrib(n,"mce_name","font"),t.setAttrib(n,"face",i.fontFamily)),i.color&&(t.setAttrib(n,"mce_name","font"),t.setAttrib(n,"color",t.toHex(i.color))),i.backgroundColor&&(t.setAttrib(n,"mce_name","font"),t.setStyle(n,"background-color",i.backgroundColor))),i.fontWeight=="bold"&&t.setAttrib(n,"mce_name","strong"),i.fontStyle=="italic"&&t.setAttrib(n,"mce_name","em"),i.textDecoration=="underline"&&t.setAttrib(n,"mce_name","u"),i.textDecoration=="line-through"&&t.setAttrib(n,"mce_name","strike"),i.verticalAlign=="super"&&t.setAttrib(n,"mce_name","sup"),i.verticalAlign=="sub"&&t.setAttrib(n,"mce_name","sub"),t.setAttrib(n,"mce_fixed","1"))},_insertBR:function(n){var r=n.dom,t=n.selection,u=t.getRng(),i;u.insertNode(i=r.create("br"));u.setStartAfter(i);u.setEndAfter(i);t.setRng(u);t.getSel().focusNode==i.previousSibling&&(t.select(r.insertAfter(r.doc.createTextNode("Â "),i)),t.collapse(1));n.getWin().scrollTo(0,r.getPos(t.getRng().startContainer).y)}});tinymce.PluginManager.add("safari",tinymce.plugins.Safari)})();