(function(){var r=tinymce.util.JSONRequest,n=tinymce.each,t=tinymce.DOM;tinymce.create("tinymce.plugins.AfterTheDeadlinePlugin",{getInfo:function(){return},init:function(t,r){var e=this,u=this,f=t;this.url=r;this.editor=t;this.ignore_strings=t.getParam("atd_ignore_strings","").split(/,/g);f.addCommand("mceWritingImprovementTool",function(){u.editor.setProgressState(1);u._removeWords();u.sendRequest("checkDocument",t.getContent({format:"raw"}),function(r,e){var l,o,h,k,d,g,nt,tt;if(u.editor.setProgressState(0),e.status!=200||e.responseText.substr(1,4)=="html"){t.windowManager.alert("There was a problem communicating with the After the Deadline service. Try again in one minute.");return}if(e.responseXML.getElementsByTagName("message").item(0)!=null){t.windowManager.alert(e.responseXML.getElementsByTagName("message").item(0).firstChild.data);return}l=tinymce.util.Cookie.getHash("atd_ignore");l==undefined&&(l={});n(u.ignore_strings,function(n){l[n]=1});o={};o["Double Negatives"]=1;o["Hidden Verbs"]=1;o["Passive voice"]=1;o["Bias Language"]=1;o.Cliches=1;o["Complex Expression"]=1;o["Jargon Language"]=1;o["Phrases to Avoid"]=1;o["Redundant Expression"]=1;n(f.getParam("atd_show_types","").split(/,/g),function(n){o[n]=undefined});f.suggestions=[];var s=e.responseXML.getElementsByTagName("error"),y=[],p=[],w=[];for(i=0;i<s.length;i++)if(s[i].getElementsByTagName("string").item(0).firstChild!=null){var c=s[i].getElementsByTagName("string").item(0).firstChild.data,v=s[i].getElementsByTagName("type").item(0).firstChild.data,b=s[i].getElementsByTagName("description").item(0).firstChild.data,a;if(a=s[i].getElementsByTagName("precontext").item(0).firstChild!=null?s[i].getElementsByTagName("precontext").item(0).firstChild.data:"",l[c]==undefined){if(h={},h.description=b,h.suggestions=[],h.matcher=new RegExp("^"+c.replace(/\s+/,u._getSeparators())+"$"),h.context=a,h.string=c,h.type=v,f.suggestions.push(h),s[i].getElementsByTagName("suggestions").item(0)!=undefined)for(k=s[i].getElementsByTagName("suggestions").item(0).getElementsByTagName("option"),j=0;j<k.length;j++)h.suggestions.push(k[j].firstChild.data);s[i].getElementsByTagName("url").item(0)!=undefined&&(d=s[i].getElementsByTagName("url").item(0).firstChild.data,g=f.getParam("atd_theme","tinymce"),h.moreinfo=d+"&theme="+g);o[b]==undefined&&(v=="suggestion"&&w.push({word:c,pre:a}),v=="grammar"&&y.push({word:c,pre:a}));(v=="spelling"||b=="Homophone")&&p.push({word:c,pre:a})}}nt=p.length+y.length+w.length;nt==0?t.windowManager.alert("No writing errors were found."):(tt=u.buildErrorStructure(p,w,y),u.markMyWords(tt))})});f.onInit.add(function(){f.settings.content_css!==!1&&f.dom.loadCSS(f.getParam("atd_css_url",r+"/css/content.css"))});f.onClick.add(u._showMenu,u);f.onContextMenu.add(u._showMenu,u);f.onPreProcess.add(function(t,i){var r=t.dom;n(r.select("span",i.node).reverse(),function(n){n&&(r.hasClass(n,"hiddenGrammarError")||r.hasClass(n,"hiddenSpellError")||r.hasClass(n,"hiddenSuggestion")||r.hasClass(n,"mceItemHidden")||r.getAttrib(n,"class")==""&&r.getAttrib(n,"style")==""&&r.getAttrib(n,"id")==""&&!r.hasClass(n,"Apple-style-span")&&r.getAttrib(n,"mce_name")=="")&&r.remove(n,1)})});f.onBeforeExecCommand.add(function(n,t){t=="mceCodeEditor"?u._removeWords():t=="mceFullScreen"&&u._done()})},createControl:function(n,t){var i=this;if(n=="AtD")return t.createButton(n,{title:"Proofread Writing",image:this.editor.getParam("atd_button_url",this.url+"/atdbuttontr.gif"),cmd:"mceWritingImprovementTool",scope:i})},_walk:function(n,t){var i=this.editor.getDoc(),r;if(i.createTreeWalker)for(r=i.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1);(n=r.nextNode())!=null;)t.call(this,n);else tinymce.walk(n,t,"childNodes")},_getSeparators:function(){for(var t="",i=this.editor.getParam("spellchecker_word_separator_chars",'" \\s!#$%&()*+,./:;<=>?@[]^_{|}����������������”“'),n=0;n<i.length;n++)t+="\\"+i.charAt(n);return"(?:(?:["+t+"])|(?:\\-\\-))+"},_removeWords:function(t){var r=this.editor,i=r.dom,u=r.selection,f=u.getBookmark();n(i.select("span").reverse(),function(n){n&&(i.hasClass(n,"hiddenGrammarError")||i.hasClass(n,"hiddenSpellError")||i.hasClass(n,"hiddenSuggestion")||i.hasClass(n,"mceItemHidden")||i.getAttrib(n,"class")==""&&i.getAttrib(n,"style")==""&&i.getAttrib(n,"id")==""&&!i.hasClass(n,"Apple-style-span")&&i.getAttrib(n,"mce_name")=="")&&(n.innerHTML=="&nbsp;"?i.replace(n," "):t&&n.innerHTML!=t||i.remove(n,1))});i.setHTML(i.getRoot(),i.getRoot().innerHTML);u.moveToBookmark(f)},makeError:function(n,t,i,r){var u={};return u.type=i,u.string=n,u.tokens=t,u.regexp=new RegExp("(?!"+n+"<)"+n.replace(/\s+/g,r)+"\\b"),u.used=!1,u},addToErrorStructure:function(t,i,r,u){var f=this;n(i,function(n){var o=n.word.split(/\s+/),e=n.pre,i=o[0];t["__"+i]==undefined&&(t["__"+i]={},t["__"+i].pretoks={},t["__"+i].defaults=[]);e==""?t["__"+i].defaults.push(f.makeError(n.word,o,r,u,e)):(t["__"+i].pretoks["__"+e]==undefined&&(t["__"+i].pretoks["__"+e]=[]),t["__"+i].pretoks["__"+e].push(f.makeError(n.word,o,r,u,e)))})},buildErrorStructure:function(n,t,i){var u=this._getSeparators(),r={};return this.addToErrorStructure(r,n,"hiddenSpellError",u),this.addToErrorStructure(r,i,"hiddenGrammarError",u),this.addToErrorStructure(r,t,"hiddenSuggestion",u),r},tokenIterate:{init:function(n){this.tokens=n;this.index=0;this.count=0;this.last=0},next:function(){var n=this.tokens[this.index];return this.count=this.last,this.last+=n.length+1,this.index++,n},hasNext:function(){return this.index<this.tokens.length},hasNextN:function(n){return this.index+n<this.tokens.length},skip:function(n,t){this.index+=n;this.last+=t;this.index<this.tokens.length&&(this.count=this.last-this.tokens[this.index].length)},getCount:function(){return this.count},peek:function(n){for(var i=[],r=this.index+n,t=this.index;t<r;t++)i.push(this.tokens[t]);return i}},markMyWords:function(t){var u=this.editor,o=new RegExp(this._getSeparators()),i=u.dom,f=[],e=u.selection,s=e.getBookmark(),r;this._walk(this.editor.getBody(),function(n){n.nodeType!=3||i.hasClass(n,"hiddenSpellError")||i.hasClass(n,"hiddenGrammarError")||i.hasClass(n,"hiddenSuggestion")||f.push(n)});r=this.tokenIterate;n(f,function(u){var l,a,f,b,v,k,p,w,h;if(u.nodeType==3){l=i.encode(u.nodeValue);var d=u.nodeValue.split(o),e="",s=[];for(r.init(d);r.hasNext();)a=r.next(),f=t["__"+a],f!=undefined&&f.pretoks!=undefined&&(b=f.defaults,f=f.pretoks["__"+e],v=!1,k=l.substr(0,r.getCount()),p=l.substr(k.length,l.length),w=function(n){if(!v&&n!=undefined&&!n.used&&n.regexp.test(p)){var t=p.length;s.push([n.regexp,'<span class="'+n.type+'" pre="'+e+'">$&<\/span>']);n.used=!0;v=!0;r.skip(n.tokens.length-1,0);a=n.tokens[n.tokens.length-1]}},f!=undefined&&(e=e+" ",n(f,w)),v||(e="",n(b,w))),e=a;if(s.length>0){for(newNode=u,h=0;h<s.length;h++){var c=s[h][0],y=s[h][1],g=function(n){var r,t,u;if(n.nodeType==3)return navigator.appName=="Microsoft Internet Explorer"&&n.nodeValue.length>0&&n.nodeValue.substr(0,1)==" "?i.create("span",{"class":"mceItemHidden"},'<span class="mceItemHidden">&nbsp;<\/span>'+n.nodeValue.substr(1,n.nodeValue.length-1).replace(c,y)):i.create("span",{"class":"mceItemHidden"},n.nodeValue.replace(c,y));for(r=n.childNodes,t=0;t<r.length;t++)if(r[t].nodeType==3&&c.test(r[t].nodeValue))return u=navigator.appName=="Microsoft Internet Explorer"&&r[t].nodeValue.length>0&&r[t].nodeValue.substr(0,1)==" "?i.create("span",{"class":"mceItemHidden"},'<span class="mceItemHidden">&nbsp;<\/span>'+r[t].nodeValue.substr(1,r[t].nodeValue.length-1).replace(c,y)):i.create("span",{"class":"mceItemHidden"},r[t].nodeValue.replace(c,y)),i.replace(u,r[t]),i.remove(u,1),n;return n};newNode=g(newNode)}i.replace(newNode,u)}}});e.moveToBookmark(s)},_showMenu:function(n,i){var u=this,n=u.editor,r=u._menu,s,o=n.dom,l=o.getViewPort(n.getWin()),v=this,h,e,c,a,f;if(r||(s=t.getPos(n.getContentAreaContainer()),r=n.controlManager.createDropMenu("spellcheckermenu",{offset_x:s.x,offset_y:s.y,"class":"mceNoIcons"}),u._menu=r),o.hasClass(i.target,"hiddenSpellError")||o.hasClass(i.target,"hiddenGrammarError")||o.hasClass(i.target,"hiddenSuggestion")){for(h=tinymce.trim(o.getAttrib(i.target,"pre")).replace(/[\\,!\\?\\."]/g,""),r.removeAll(),c=n.suggestions.length,f=0;f<c;f++)if(a=n.suggestions[f].string,(h==""||h==n.suggestions[f].context)&&n.suggestions[f].matcher.test(i.target.innerHTML)){e=n.suggestions[f];break}if(e==undefined)r.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1);else if(e.suggestions.length==0)r.add({title:e.description,"class":"mceMenuItemTitle"}).setDisabled(1);else{for(r.add({title:e.description,"class":"mceMenuItemTitle"}).setDisabled(1),f=0;f<e.suggestions.length;f++)(function(t){r.add({title:t,onclick:function(){t=="(omit)"?o.remove(i.target):o.replace(n.getDoc().createTextNode(t),i.target);u._checkDone()}})})(e.suggestions[f]);r.addSeparator()}return e!=undefined&&e.moreinfo!=null&&(function(t){r.add({title:"Explain ...",onclick:function(){n.windowManager.open({url:t,width:480,height:380,inline:!0},{theme_url:this.url})}})}(e.moreinfo),r.addSeparator()),r.add({title:"Ignore suggestion",onclick:function(){o.remove(i.target,1);u._checkDone()}}),this.editor.getParam("atd_ignore_enable","false")=="true"?r.add({title:"Ignore always",onclick:function(){var t=u.editor.getParam("atd_ignore_rpc_url","{backend}"),n,r;t=="{backend}"?(n=tinymce.util.Cookie.getHash("atd_ignore"),n==undefined&&(n={}),n[i.target.innerHTML]=1,tinymce.util.Cookie.setHash("atd_ignore",n,new Date((new Date).getTime()+15768e7))):(r=u.editor.getParam("atd_rpc_id","12345678"),tinymce.util.XHR.send({url:t+encodeURI(i.target.innerHTML).replace(/&/g,"%26")+"&key="+r,content_type:"text/xml",async:!0,type:"GET",success:function(){},error:function(n,t,i){alert("Ignore preference save failed\n"+n+"\n"+t.status+"\nAt: "+i.url)}}),u.ignore_strings.push(i.target.innerHTML));u._removeWords(i.target.innerHTML);u._checkDone()}}):r.add({title:"Ignore all",onclick:function(){u._removeWords(i.target.innerHTML);u._checkDone()}}),n.selection.select(i.target),s=o.getPos(i.target),r.showMenu(s.x,s.y+i.target.offsetHeight-l.y),tinymce.dom.Event.cancel(i)}r.hideMenu()},_checkDone:function(){var t=this,u=t.editor,i=u.dom,r;n(i.select("span"),function(n){if(n&&i.hasClass(n,"mceItemHidden"))return r=!0,!1});r||t._done()},_done:function(){var n=this;n._removeWords();n._menu&&n._menu.hideMenu();n.editor.nodeChanged()},sendRequest:function(n,t,i){var u=this.editor.getParam("atd_rpc_id","12345678"),r=this.editor.getParam("atd_rpc_url","{backend}"),f=this;if(r=="{backend}"||u=="12345678"){this.editor.setProgressState(0);alert("Please specify: atd_rpc_url and atd_rpc_id");return}tinymce.util.XHR.send({url:r+"/"+n,content_type:"text/xml",type:"POST",data:encodeURI(t).replace(/&/g,"%26"),async:!0,success:i,error:function(n,t,i){f.editor.setProgressState(0);alert(n+"\n"+t.status+"\nAt: "+i.url)}})}});tinymce.PluginManager.add("AtD",tinymce.plugins.AfterTheDeadlinePlugin)})();